blueprint:
  name: Philips Hue Tap Dial - Custom Controls (zigbee2mqtt)
  domain: automation
  homeassistant:
    min_version: 2024.10.0
  source_url: https://gist.github.com/zeeMonkeez/3e9f9cd68f9368d09973d5e5d437a4dd
  description: >
    # Philips Hue Tap Dial - Custom Controls (zigbee2mqtt version)

    Blueprint dostosowany do pracy z Philips Hue Tap Dial podłączonym przez zigbee2mqtt.

    ## Kluczowe funkcje

    * Akcje dla przycisków: krótkie naciśnięcie, długie naciśnięcie, przytrzymanie
    * Akcje dla pokrętła: step (pojedynczy krok), slow (wolne obracanie), fast (szybkie obracanie)
    * Pokrętło może zapamiętać ostatnio naciśnięty przycisk i wykonywać różne akcje

    ## Akcje przycisków

    Każdy przycisk obsługuje:
    * Short Press (krótkie naciśnięcie)
    * Short Release (zwolnienie po krótkim naciśnięciu)
    * Long Press/Hold (długie przytrzymanie - może się powtarzać)
    * Long Release (zwolnienie po długim przytrzymaniu)

    ## Akcje pokrętła

    Pokrętło obsługuje 3 prędkości w każdym kierunku:
    * Step - pojedynczy krok (jedno kliknięcie)
    * Slow - wolne ciągłe obracanie
    * Fast - szybkie ciągłe obracanie

    ## Rozszerzone sterowanie pokrętłem

    Możesz skonfigurować różne akcje pokrętła dla każdego przycisku.
    Wymaga utworzenia helpera input_number do zapamiętania ostatniego przycisku.

    ## Version History:

    2.00 (Dec-14-2025): Wersja dla zigbee2mqtt

  input:
    device_friendly_name:
      name: Friendly Name urządzenia w zigbee2mqtt
      description: >
        Wpisz dokładnie friendly name urządzenia z zigbee2mqtt.
        
        Możesz to sprawdzić:
        - W interfejsie zigbee2mqtt
        - W nazwach sensorów (np. jeśli sensor to "sensor.adrian_przelacznik_glowny_hue_action_type", 
          friendly name to "Adrian_Przełącznik_Główny_HUE")
      selector:
        text:
    logbook_enabled:
      name: Włącz logowanie do Logbook
      default: false
      selector:
        boolean: {}
    rotation_controls:
      name: Sterowanie pokrętłem
      description: "Akcje wywoływane przy obracaniu pokrętła (dla przycisku 1 lub domyślnie)"
      icon: mdi:rotate-360
      collapsed: true
      input:
        clockwise_rotation_step:
          name: Obrót w prawo - Step
          description: Pojedynczy krok w prawo
          default: []
          selector:
            action: {}
        clockwise_rotation_slow:
          name: Obrót w prawo - Slow
          description: Wolne ciągłe obracanie w prawo
          default: []
          selector:
            action: {}
        clockwise_rotation_fast:
          name: Obrót w prawo - Fast
          description: Szybkie ciągłe obracanie w prawo
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_step:
          name: Obrót w lewo - Step
          description: Pojedynczy krok w lewo
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_slow:
          name: Obrót w lewo - Slow
          description: Wolne ciągłe obracanie w lewo
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_fast:
          name: Obrót w lewo - Fast
          description: Szybkie ciągłe obracanie w lewo
          default: []
          selector:
            action: {}
    rotation_controls_extended:
      name: Rozszerzone sterowanie pokrętłem
      description: Różne akcje pokrętła dla każdego przycisku
      icon: mdi:rotate-orbit
      collapsed: true
      input:
        helper_last_button_pressed:
          name: Helper - Ostatni naciśnięty przycisk
          description: Input Number do zapamiętania ostatniego przycisku (stwórz helper w Ustawieniach)
          default: ''
          selector:
            entity:
              domain:
                - input_number
        # Button 2 rotations
        clockwise_rotation_step_2:
          name: Przycisk 2 - Obrót w prawo Step
          default: []
          selector:
            action: {}
        clockwise_rotation_slow_2:
          name: Przycisk 2 - Obrót w prawo Slow
          default: []
          selector:
            action: {}
        clockwise_rotation_fast_2:
          name: Przycisk 2 - Obrót w prawo Fast
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_step_2:
          name: Przycisk 2 - Obrót w lewo Step
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_slow_2:
          name: Przycisk 2 - Obrót w lewo Slow
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_fast_2:
          name: Przycisk 2 - Obrót w lewo Fast
          default: []
          selector:
            action: {}
        # Button 3 rotations
        clockwise_rotation_step_3:
          name: Przycisk 3 - Obrót w prawo Step
          default: []
          selector:
            action: {}
        clockwise_rotation_slow_3:
          name: Przycisk 3 - Obrót w prawo Slow
          default: []
          selector:
            action: {}
        clockwise_rotation_fast_3:
          name: Przycisk 3 - Obrót w prawo Fast
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_step_3:
          name: Przycisk 3 - Obrót w lewo Step
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_slow_3:
          name: Przycisk 3 - Obrót w lewo Slow
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_fast_3:
          name: Przycisk 3 - Obrót w lewo Fast
          default: []
          selector:
            action: {}
        # Button 4 rotations
        clockwise_rotation_step_4:
          name: Przycisk 4 - Obrót w prawo Step
          default: []
          selector:
            action: {}
        clockwise_rotation_slow_4:
          name: Przycisk 4 - Obrót w prawo Slow
          default: []
          selector:
            action: {}
        clockwise_rotation_fast_4:
          name: Przycisk 4 - Obrót w prawo Fast
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_step_4:
          name: Przycisk 4 - Obrót w lewo Step
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_slow_4:
          name: Przycisk 4 - Obrót w lewo Slow
          default: []
          selector:
            action: {}
        counter_clockwise_rotation_fast_4:
          name: Przycisk 4 - Obrót w lewo Fast
          default: []
          selector:
            action: {}

    button_1_custom:
      name: Przycisk 1 - Akcje
      icon: mdi:numeric-1-circle-outline
      collapsed: true
      input:
        button_1_short:
          name: Przycisk 1 (Krótkie naciśnięcie)
          default: []
          selector:
            action: {}
        button_1_short_release:
          name: Przycisk 1 (Zwolnienie po krótkim)
          default: []
          selector:
            action: {}
        button_1_long:
          name: Przycisk 1 (Długie przytrzymanie)
          description: Powtarza się podczas trzymania
          default: []
          selector:
            action: {}
        button_1_long_release:
          name: Przycisk 1 (Zwolnienie po długim)
          default: []
          selector:
            action: {}
    button_2_custom:
      name: Przycisk 2 - Akcje
      icon: mdi:numeric-2-circle-outline
      collapsed: true
      input:
        button_2_short:
          name: Przycisk 2 (Krótkie naciśnięcie)
          default: []
          selector:
            action: {}
        button_2_short_release:
          name: Przycisk 2 (Zwolnienie po krótkim)
          default: []
          selector:
            action: {}
        button_2_long:
          name: Przycisk 2 (Długie przytrzymanie)
          default: []
          selector:
            action: {}
        button_2_long_release:
          name: Przycisk 2 (Zwolnienie po długim)
          default: []
          selector:
            action: {}
    button_3_custom:
      name: Przycisk 3 - Akcje
      icon: mdi:numeric-3-circle-outline
      collapsed: true
      input:
        button_3_short:
          name: Przycisk 3 (Krótkie naciśnięcie)
          default: []
          selector:
            action: {}
        button_3_short_release:
          name: Przycisk 3 (Zwolnienie po krótkim)
          default: []
          selector:
            action: {}
        button_3_long:
          name: Przycisk 3 (Długie przytrzymanie)
          default: []
          selector:
            action: {}
        button_3_long_release:
          name: Przycisk 3 (Zwolnienie po długim)
          default: []
          selector:
            action: {}
    button_4_custom:
      name: Przycisk 4 - Akcje
      icon: mdi:numeric-4-circle-outline
      collapsed: true
      input:
        button_4_short:
          name: Przycisk 4 (Krótkie naciśnięcie)
          default: []
          selector:
            action: {}
        button_4_short_release:
          name: Przycisk 4 (Zwolnienie po krótkim)
          default: []
          selector:
            action: {}
        button_4_long:
          name: Przycisk 4 (Długie przytrzymanie)
          default: []
          selector:
            action: {}
        button_4_long_release:
          name: Przycisk 4 (Zwolnienie po długim)
          default: []
          selector:
            action: {}

mode: restart
max_exceeded: silent

trigger:
  - platform: mqtt
    topic: "zigbee2mqtt/{{ device_friendly_name }}"

action:
  - variables:
      device_friendly_name: !input device_friendly_name
      payload: "{{ trigger.payload_json }}"
      action: "{{ payload.action | default('') }}"
      action_direction: "{{ payload.action_direction | default('') }}"
      action_type: "{{ payload.action_type | default('') }}"
      step_size: "{{ payload.action_step_size | default(0) | int }}"
      logbook_enabled: !input logbook_enabled
      helper_last_button_pressed: !input helper_last_button_pressed
      last_button_pressed: >
        {%- set helper_state = states(helper_last_button_pressed) -%}
        {{ helper_state | int if is_number(helper_state) else 1 }}
      # Mapowanie akcji z zigbee2mqtt na nazwy w blueprincie
      # zigbee2mqtt: button_1_press -> blueprint: button_1_short
      # zigbee2mqtt: button_1_press_release -> blueprint: button_1_short_release
      # zigbee2mqtt: button_1_hold -> blueprint: button_1_long
      # zigbee2mqtt: button_1_hold_release -> blueprint: button_1_long_release
      mapped_action: >
        {% set a = action %}
        {% if '_press_release' in a %}
          {{ a.replace('_press_release', '_short_release') }}
        {% elif a.endswith('_press') %}
          {{ a.replace('_press', '_short') }}
        {% elif '_hold_release' in a %}
          {{ a.replace('_hold_release', '_long_release') }}
        {% elif a.endswith('_hold') %}
          {{ a.replace('_hold', '_long') }}
        {% else %}
          {{ a }}
        {% endif %}

  - choose:
      - conditions: "{{ logbook_enabled }}"
        sequence:
          - service: logbook.log
            data:
              name: Hue Tap Dial (zigbee2mqtt)
              message: "Device: {{ device_friendly_name }}, Action: {{ action }}, Mapped: {{ mapped_action }}, Direction: {{ action_direction }}, Step: {{ step_size }}"

  - choose:
      # Button 1 actions
      - conditions: "{{ mapped_action == 'button_1_short' }}"
        sequence:
          - sequence: !input button_1_short
          - &save_b_1
            if: ["{{ states(helper_last_button_pressed) != 'unknown'}}"]
            then:
              action: input_number.set_value
              target:
                entity_id: "{{ helper_last_button_pressed }}"
              data:
                value: 1
      - conditions: "{{ mapped_action == 'button_1_short_release' }}"
        sequence:
          - sequence: !input button_1_short_release
          - *save_b_1
      - conditions: "{{ mapped_action == 'button_1_long' }}"
        sequence: !input button_1_long
      - conditions: "{{ mapped_action == 'button_1_long_release' }}"
        sequence:
          - sequence: !input button_1_long_release
          - *save_b_1

      # Button 2 actions
      - conditions: "{{ mapped_action == 'button_2_short' }}"
        sequence:
          - sequence: !input button_2_short
          - &save_b_2
            if: ["{{ states(helper_last_button_pressed) != 'unknown'}}"]
            then:
              action: input_number.set_value
              target:
                entity_id: "{{ helper_last_button_pressed }}"
              data:
                value: 2
      - conditions: "{{ mapped_action == 'button_2_short_release' }}"
        sequence:
          - sequence: !input button_2_short_release
          - *save_b_2
      - conditions: "{{ mapped_action == 'button_2_long' }}"
        sequence: !input button_2_long
      - conditions: "{{ mapped_action == 'button_2_long_release' }}"
        sequence:
          - sequence: !input button_2_long_release
          - *save_b_2

      # Button 3 actions
      - conditions: "{{ mapped_action == 'button_3_short' }}"
        sequence:
          - sequence: !input button_3_short
          - &save_b_3
            if: ["{{ states(helper_last_button_pressed) != 'unknown'}}"]
            then:
              action: input_number.set_value
              target:
                entity_id: "{{ helper_last_button_pressed }}"
              data:
                value: 3
      - conditions: "{{ mapped_action == 'button_3_short_release' }}"
        sequence:
          - sequence: !input button_3_short_release
          - *save_b_3
      - conditions: "{{ mapped_action == 'button_3_long' }}"
        sequence: !input button_3_long
      - conditions: "{{ mapped_action == 'button_3_long_release' }}"
        sequence:
          - sequence: !input button_3_long_release
          - *save_b_3

      # Button 4 actions
      - conditions: "{{ mapped_action == 'button_4_short' }}"
        sequence:
          - sequence: !input button_4_short
          - &save_b_4
            if: ["{{ states(helper_last_button_pressed) != 'unknown'}}"]
            then:
              action: input_number.set_value
              target:
                entity_id: "{{ helper_last_button_pressed }}"
              data:
                value: 4
      - conditions: "{{ mapped_action == 'button_4_short_release' }}"
        sequence:
          - sequence: !input button_4_short_release
          - *save_b_4
      - conditions: "{{ mapped_action == 'button_4_long' }}"
        sequence: !input button_4_long
      - conditions: "{{ mapped_action == 'button_4_long_release' }}"
        sequence:
          - sequence: !input button_4_long_release
          - *save_b_4

      # Dial rotations - Right
      - conditions: "{{ action == 'dial_rotate_right_step' }}"
        sequence:
          - choose:
              - conditions: "{{ last_button_pressed == 1 }}"
                sequence: !input clockwise_rotation_step
              - conditions: "{{ last_button_pressed == 2 }}"
                sequence: !input clockwise_rotation_step_2
              - conditions: "{{ last_button_pressed == 3 }}"
                sequence: !input clockwise_rotation_step_3
              - conditions: "{{ last_button_pressed == 4 }}"
                sequence: !input clockwise_rotation_step_4
      - conditions: "{{ action == 'dial_rotate_right_slow' }}"
        sequence:
          - choose:
              - conditions: "{{ last_button_pressed == 1 }}"
                sequence: !input clockwise_rotation_slow
              - conditions: "{{ last_button_pressed == 2 }}"
                sequence: !input clockwise_rotation_slow_2
              - conditions: "{{ last_button_pressed == 3 }}"
                sequence: !input clockwise_rotation_slow_3
              - conditions: "{{ last_button_pressed == 4 }}"
                sequence: !input clockwise_rotation_slow_4
      - conditions: "{{ action == 'dial_rotate_right_fast' }}"
        sequence:
          - choose:
              - conditions: "{{ last_button_pressed == 1 }}"
                sequence: !input clockwise_rotation_fast
              - conditions: "{{ last_button_pressed == 2 }}"
                sequence: !input clockwise_rotation_fast_2
              - conditions: "{{ last_button_pressed == 3 }}"
                sequence: !input clockwise_rotation_fast_3
              - conditions: "{{ last_button_pressed == 4 }}"
                sequence: !input clockwise_rotation_fast_4

      # Dial rotations - Left
      - conditions: "{{ action == 'dial_rotate_left_step' }}"
        sequence:
          - choose:
              - conditions: "{{ last_button_pressed == 1 }}"
                sequence: !input counter_clockwise_rotation_step
              - conditions: "{{ last_button_pressed == 2 }}"
                sequence: !input counter_clockwise_rotation_step_2
              - conditions: "{{ last_button_pressed == 3 }}"
                sequence: !input counter_clockwise_rotation_step_3
              - conditions: "{{ last_button_pressed == 4 }}"
                sequence: !input counter_clockwise_rotation_step_4
      - conditions: "{{ action == 'dial_rotate_left_slow' }}"
        sequence:
          - choose:
              - conditions: "{{ last_button_pressed == 1 }}"
                sequence: !input counter_clockwise_rotation_slow
              - conditions: "{{ last_button_pressed == 2 }}"
                sequence: !input counter_clockwise_rotation_slow_2
              - conditions: "{{ last_button_pressed == 3 }}"
                sequence: !input counter_clockwise_rotation_slow_3
              - conditions: "{{ last_button_pressed == 4 }}"
                sequence: !input counter_clockwise_rotation_slow_4
      - conditions: "{{ action == 'dial_rotate_left_fast' }}"
        sequence:
          - choose:
              - conditions: "{{ last_button_pressed == 1 }}"
                sequence: !input counter_clockwise_rotation_fast
              - conditions: "{{ last_button_pressed == 2 }}"
                sequence: !input counter_clockwise_rotation_fast_2
              - conditions: "{{ last_button_pressed == 3 }}"
                sequence: !input counter_clockwise_rotation_fast_3
              - conditions: "{{ last_button_pressed == 4 }}"
                sequence: !input counter_clockwise_rotation_fast_4
