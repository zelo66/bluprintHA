blueprint:
  name: Philips Hue Tap Dial - Timeout Mode (zigbee2mqtt)
  domain: automation
  description: >
    Pełna kontrola Philips Hue Tap Dial z funkcją TIMEOUT DLA POKRĘTŁA.
    
    **Zasada działania:**
    1. Klikasz przycisk (1-4).
    2. Ustawia się kontekst przycisku i uruchamia Timer (np. na 5s).
    3. W tym czasie pokrętło steruje przypisaną funkcją.
    4. Po upływie czasu pokrętło przestaje reagować (zabezpieczenie przed przypadkowym obrotem).
    
    **Wymagane helpery:**
    - Counter (do wykrywania double press)
    - Input Text (do zapamiętania ostatniego przycisku)
    - **Timer (Minutnik)** - NOWOŚĆ: do odliczania czasu aktywności
  input:
    mqtt_topic:
      name: MQTT Topic
      description: Topic urządzenia w zigbee2mqtt
      selector:
        text:
    tap_counter:
      name: Counter Helper (wykrywanie multi-press)
      description: Utwórz Counter helper dla tego switcha
      selector:
        entity:
          domain: counter
          multiple: false
    last_pressed:
      name: Input Text Helper (ostatni przycisk)
      description: Utwórz Input Text helper
      selector:
        entity:
          domain: input_text
          multiple: false
    dial_timer_helper:
      name: Timer Helper (Minutnik)
      description: Wymagany do odliczania czasu aktywności pokrętła (np. 5s)
      selector:
        entity:
          domain: timer
          multiple: false
    dial_active_time:
      name: Czas aktywności pokrętła
      description: Jak długo pokrętło ma działać po wciśnięciu przycisku (sekundy).
      default: 5
      selector:
        number:
          min: 1
          max: 60
          step: 1
          unit_of_measurement: s
          mode: slider
    double_click_delay:
      name: Czas na double click (sekundy)
      description: Maksymalny czas między kliknięciami
      default: 1
      selector:
        number:
          min: 0.3
          max: 3.0
          step: 0.1
          unit_of_measurement: s
          mode: slider
    logbook_enabled:
      name: Włącz logowanie do Logbook
      default: false
      selector:
        boolean: {}
    
    # Button 1
    button_1_single_press:
      name: Button 1 - Single Press
      default: []
      selector:
        action: {}
    button_1_double_press:
      name: Button 1 - Double Press
      default: []
      selector:
        action: {}
    button_1_hold:
      name: Button 1 - Hold
      default: []
      selector:
        action: {}
    button_1_rotate_right_step:
      name: Button 1 - Rotate Right (Step)
      default: []
      selector:
        action: {}
    button_1_rotate_right_slow:
      name: Button 1 - Rotate Right (Slow)
      default: []
      selector:
        action: {}
    button_1_rotate_right_fast:
      name: Button 1 - Rotate Right (Fast)
      default: []
      selector:
        action: {}
    button_1_rotate_left_step:
      name: Button 1 - Rotate Left (Step)
      default: []
      selector:
        action: {}
    button_1_rotate_left_slow:
      name: Button 1 - Rotate Left (Slow)
      default: []
      selector:
        action: {}
    button_1_rotate_left_fast:
      name: Button 1 - Rotate Left (Fast)
      default: []
      selector:
        action: {}
    
    # Button 2
    button_2_single_press:
      name: Button 2 - Single Press
      default: []
      selector:
        action: {}
    button_2_double_press:
      name: Button 2 - Double Press
      default: []
      selector:
        action: {}
    button_2_hold:
      name: Button 2 - Hold
      default: []
      selector:
        action: {}
    button_2_rotate_right_step:
      name: Button 2 - Rotate Right (Step)
      default: []
      selector:
        action: {}
    button_2_rotate_right_slow:
      name: Button 2 - Rotate Right (Slow)
      default: []
      selector:
        action: {}
    button_2_rotate_right_fast:
      name: Button 2 - Rotate Right (Fast)
      default: []
      selector:
        action: {}
    button_2_rotate_left_step:
      name: Button 2 - Rotate Left (Step)
      default: []
      selector:
        action: {}
    button_2_rotate_left_slow:
      name: Button 2 - Rotate Left (Slow)
      default: []
      selector:
        action: {}
    button_2_rotate_left_fast:
      name: Button 2 - Rotate Left (Fast)
      default: []
      selector:
        action: {}
    
    # Button 3
    button_3_single_press:
      name: Button 3 - Single Press
      default: []
      selector:
        action: {}
    button_3_double_press:
      name: Button 3 - Double Press
      default: []
      selector:
        action: {}
    button_3_hold:
      name: Button 3 - Hold
      default: []
      selector:
        action: {}
    button_3_rotate_right_step:
      name: Button 3 - Rotate Right (Step)
      default: []
      selector:
        action: {}
    button_3_rotate_right_slow:
      name: Button 3 - Rotate Right (Slow)
      default: []
      selector:
        action: {}
    button_3_rotate_right_fast:
      name: Button 3 - Rotate Right (Fast)
      default: []
      selector:
        action: {}
    button_3_rotate_left_step:
      name: Button 3 - Rotate Left (Step)
      default: []
      selector:
        action: {}
    button_3_rotate_left_slow:
      name: Button 3 - Rotate Left (Slow)
      default: []
      selector:
        action: {}
    button_3_rotate_left_fast:
      name: Button 3 - Rotate Left (Fast)
      default: []
      selector:
        action: {}
    
    # Button 4
    button_4_single_press:
      name: Button 4 - Single Press
      default: []
      selector:
        action: {}
    button_4_double_press:
      name: Button 4 - Double Press
      default: []
      selector:
        action: {}
    button_4_hold:
      name: Button 4 - Hold
      default: []
      selector:
        action: {}
    button_4_rotate_right_step:
      name: Button 4 - Rotate Right (Step)
      default: []
      selector:
        action: {}
    button_4_rotate_right_slow:
      name: Button 4 - Rotate Right (Slow)
      default: []
      selector:
        action: {}
    button_4_rotate_right_fast:
      name: Button 4 - Rotate Right (Fast)
      default: []
      selector:
        action: {}
    button_4_rotate_left_step:
      name: Button 4 - Rotate Left (Step)
      default: []
      selector:
        action: {}
    button_4_rotate_left_slow:
      name: Button 4 - Rotate Left (Slow)
      default: []
      selector:
        action: {}
    button_4_rotate_left_fast:
      name: Button 4 - Rotate Left (Fast)
      default: []
      selector:
        action: {}

mode: parallel
max: 50
max_exceeded: silent

trigger:
  - platform: mqtt
    topic: !input mqtt_topic

condition:
  - condition: template
    value_template: "{{ trigger.payload_json.action != '' }}"

action:
  - variables:
      input_text_var: !input last_pressed
      counter_var: !input tap_counter
      timer_var: !input dial_timer_helper
      active_time: !input dial_active_time
      double_click_delay: !input double_click_delay
      logbook_enabled: !input logbook_enabled
      action: "{{ trigger.payload_json.action }}"
  
  # Logowanie do logbook
  - choose:
      - conditions: "{{ logbook_enabled }}"
        sequence:
          - service: logbook.log
            data:
              name: "Hue Tap Dial"
              message: "Action: {{ action }}, Last Btn: {{ states(input_text_var) }}, Timer: {{ states(timer_var) }}"
  
  # === SEKCJA PRZYCISKÓW (Aktywuje Timer) ===
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ action is match('^button_[1-4]_press$') }}"
        sequence:
          # Reset licznika jeśli inny przycisk
          - if:
              - condition: template
                value_template: "{{ action | regex_replace(find='[^1-4]', replace='') != states(input_text_var) }}"
            then:
              - service: counter.reset
                target:
                  entity_id: "{{ counter_var }}"
          # Zapisz ID przycisku
          - service: input_text.set_value
            data:
              value: "{{ action | regex_replace(find='[^1-4]', replace='') }}"
            target:
              entity_id: "{{ input_text_var }}"
          # START TIMERA (To jest kluczowe dla Twojego wymagania)
          - service: timer.start
            target:
              entity_id: "{{ timer_var }}"
            data:
              duration: "{{ active_time }}"
          # Inkrementacja licznika
          - service: counter.increment
            target:
              entity_id: "{{ counter_var }}"
          # Delay na double click
          - delay:
              seconds: "{{ double_click_delay }}"
          # Reset licznika po czasie
          - service: counter.reset
            target:
              entity_id: "{{ counter_var }}"
      
      # Wykryto Double Press (Również startuje/resetuje timer, bo to interakcja)
      - conditions:
          - condition: template
            value_template: "{{ action is match('button_[1-4]_press_release') and states(counter_var) | int > 1 }}"
        sequence:
          # Restart timera przy double click (żeby nie wygasł w trakcie)
          - service: timer.start
            target:
              entity_id: "{{ timer_var }}"
            data:
              duration: "{{ active_time }}"
          - choose:
              - conditions: "{{ action == 'button_1_press_release' }}"
                sequence: !input button_1_double_press
              - conditions: "{{ action == 'button_2_press_release' }}"
                sequence: !input button_2_double_press
              - conditions: "{{ action == 'button_3_press_release' }}"
                sequence: !input button_3_double_press
              - conditions: "{{ action == 'button_4_press_release' }}"
                sequence: !input button_4_double_press
    
    # === SEKCJA DOMYŚLNA (Release, Hold, Rotation) ===
    default:
      # Release - check double press
      - if:
          - condition: template
            value_template: "{{ action is match('button_[1-4]_press_release') }}"
        then:
          - delay:
              milliseconds: 250
          - if:
              - condition: template
                value_template: "{{ states(counter_var) | int > 1 }}"
            then:
              - stop: "Double press detected"
      
      # Hold (Traktujemy jako interakcję -> też powinien resetować timer)
      - if:
          - condition: template
            value_template: "{{ action is match('button_[1-4]_hold') }}"
        then:
           - service: timer.start
             target:
               entity_id: "{{ timer_var }}"
             data:
               duration: "{{ active_time }}"

      # === POKRĘTŁO I PRZYCISKI - GLOWNE ACTION ===
      - choose:
          # BUTTON 1
          - conditions: "{{ states(input_text_var) == '1' }}"
            sequence:
              - choose:
                  # ROTACJA: Działa TYLKO gdy timer jest 'active'
                  - conditions: "{{ action == 'dial_rotate_right_step' and states(timer_var) == 'active' }}"
                    sequence: !input button_1_rotate_right_step
                  - conditions: "{{ action == 'dial_rotate_right_slow' and states(timer_var) == 'active' }}"
                    sequence: !input button_1_rotate_right_slow
                  - conditions: "{{ action == 'dial_rotate_right_fast' and states(timer_var) == 'active' }}"
                    sequence: !input button_1_rotate_right_fast
                  - conditions: "{{ action == 'dial_rotate_left_step' and states(timer_var) == 'active' }}"
                    sequence: !input button_1_rotate_left_step
                  - conditions: "{{ action == 'dial_rotate_left_slow' and states(timer_var) == 'active' }}"
                    sequence: !input button_1_rotate_left_slow
                  - conditions: "{{ action == 'dial_rotate_left_fast' and states(timer_var) == 'active' }}"
                    sequence: !input button_1_rotate_left_fast
                  # Akcje przycisków
                  - conditions: "{{ action == 'button_1_press_release' }}"
                    sequence: !input button_1_single_press
                  - conditions: "{{ action == 'button_1_hold' }}"
                    sequence: !input button_1_hold

          # BUTTON 2
          - conditions: "{{ states(input_text_var) == '2' }}"
            sequence:
              - choose:
                  - conditions: "{{ action == 'dial_rotate_right_step' and states(timer_var) == 'active' }}"
                    sequence: !input button_2_rotate_right_step
                  - conditions: "{{ action == 'dial_rotate_right_slow' and states(timer_var) == 'active' }}"
                    sequence: !input button_2_rotate_right_slow
                  - conditions: "{{ action == 'dial_rotate_right_fast' and states(timer_var) == 'active' }}"
                    sequence: !input button_2_rotate_right_fast
                  - conditions: "{{ action == 'dial_rotate_left_step' and states(timer_var) == 'active' }}"
                    sequence: !input button_2_rotate_left_step
                  - conditions: "{{ action == 'dial_rotate_left_slow' and states(timer_var) == 'active' }}"
                    sequence: !input button_2_rotate_left_slow
                  - conditions: "{{ action == 'dial_rotate_left_fast' and states(timer_var) == 'active' }}"
                    sequence: !input button_2_rotate_left_fast
                  - conditions: "{{ action == 'button_2_press_release' }}"
                    sequence: !input button_2_single_press
                  - conditions: "{{ action == 'button_2_hold' }}"
                    sequence: !input button_2_hold

          # BUTTON 3
          - conditions: "{{ states(input_text_var) == '3' }}"
            sequence:
              - choose:
                  - conditions: "{{ action == 'dial_rotate_right_step' and states(timer_var) == 'active' }}"
                    sequence: !input button_3_rotate_right_step
                  - conditions: "{{ action == 'dial_rotate_right_slow' and states(timer_var) == 'active' }}"
                    sequence: !input button_3_rotate_right_slow
                  - conditions: "{{ action == 'dial_rotate_right_fast' and states(timer_var) == 'active' }}"
                    sequence: !input button_3_rotate_right_fast
                  - conditions: "{{ action == 'dial_rotate_left_step' and states(timer_var) == 'active' }}"
                    sequence: !input button_3_rotate_left_step
                  - conditions: "{{ action == 'dial_rotate_left_slow' and states(timer_var) == 'active' }}"
                    sequence: !input button_3_rotate_left_slow
                  - conditions: "{{ action == 'dial_rotate_left_fast' and states(timer_var) == 'active' }}"
                    sequence: !input button_3_rotate_left_fast
                  - conditions: "{{ action == 'button_3_press_release' }}"
                    sequence: !input button_3_single_press
                  - conditions: "{{ action == 'button_3_hold' }}"
                    sequence: !input button_3_hold

          # BUTTON 4
          - conditions: "{{ states(input_text_var) == '4' }}"
            sequence:
              - choose:
                  - conditions: "{{ action == 'dial_rotate_right_step' and states(timer_var) == 'active' }}"
                    sequence: !input button_4_rotate_right_step
                  - conditions: "{{ action == 'dial_rotate_right_slow' and states(timer_var) == 'active' }}"
                    sequence: !input button_4_rotate_right_slow
                  - conditions: "{{ action == 'dial_rotate_right_fast' and states(timer_var) == 'active' }}"
                    sequence: !input button_4_rotate_right_fast
                  - conditions: "{{ action == 'dial_rotate_left_step' and states(timer_var) == 'active' }}"
                    sequence: !input button_4_rotate_left_step
                  - conditions: "{{ action == 'dial_rotate_left_slow' and states(timer_var) == 'active' }}"
                    sequence: !input button_4_rotate_left_slow
                  - conditions: "{{ action == 'dial_rotate_left_fast' and states(timer_var) == 'active' }}"
                    sequence: !input button_4_rotate_left_fast
                  - conditions: "{{ action == 'button_4_press_release' }}"
                    sequence: !input button_4_single_press
                  - conditions: "{{ action == 'button_4_hold' }}"
                    sequence: !input button_4_hold
