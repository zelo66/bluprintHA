blueprint:
  name: "Philips Hue Tap Dial - Smart Dimmer V2 (Z2M)"
  domain: automation
  description: >
    Wersja poprawiona.
    Pełna kontrola Philips Hue Tap Dial przez zigbee2mqtt.
    
    Wymagane helpery:
    1. Timer (Minutnik) - do odliczania czasu aktywności pokrętła.
    2. Input Text - do pamiętania ostatniego przycisku.
    3. Counter - do obsługi double-click (opcjonalnie, jeśli używasz).
  
  input:
    mqtt_topic:
      name: "Zigbee2MQTT Topic"
      description: "Np. zigbee2mqtt/Salon_Hue_Dial"
      selector:
        text: {}

    dial_timer_helper:
      name: "Helper: Timer (Minutnik)"
      description: "Niezbędny. Utwórz helper typu Timer."
      selector:
        entity:
          domain: timer
          multiple: false

    last_pressed:
      name: "Helper: Input Text"
      description: "Niezbędny. Utwórz helper typu Input Text."
      selector:
        entity:
          domain: input_text
          multiple: false

    tap_counter:
      name: "Helper: Counter (Licznik)"
      description: "Używany do wykrywania podwójnych kliknięć."
      selector:
        entity:
          domain: counter
          multiple: false

    dial_active_time:
      name: "Czas aktywności pokrętła (s)"
      description: "Przez ile sekund pokrętło steruje światłem po kliknięciu."
      default: 5
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: s
          mode: slider
          
    # === BUTTON 1 ===
    btn_1_light:
      name: "(B1) Sterowanie jasnością"
      description: "Wybierz światło dla przycisku 1."
      default: []
      selector:
        entity:
          domain: light
          multiple: true
    btn_1_action:
      name: "(B1) Akcja po kliknięciu"
      default: []
      selector:
        action: {}

    # === BUTTON 2 ===
    btn_2_light:
      name: "(B2) Sterowanie jasnością"
      description: "Wybierz światło dla przycisku 2."
      default: []
      selector:
        entity:
          domain: light
          multiple: true
    btn_2_action:
      name: "(B2) Akcja po kliknięciu"
      default: []
      selector:
        action: {}

    # === BUTTON 3 ===
    btn_3_light:
      name: "(B3) Sterowanie jasnością"
      description: "Wybierz światło dla przycisku 3."
      default: []
      selector:
        entity:
          domain: light
          multiple: true
    btn_3_action:
      name: "(B3) Akcja po kliknięciu"
      default: []
      selector:
        action: {}

    # === BUTTON 4 ===
    btn_4_light:
      name: "(B4) Sterowanie jasnością"
      description: "Wybierz światło dla przycisku 4."
      default: []
      selector:
        entity:
          domain: light
          multiple: true
    btn_4_action:
      name: "(B4) Akcja po kliknięciu"
      default: []
      selector:
        action: {}

mode: queued
max: 10

trigger:
  - platform: mqtt
    topic: !input mqtt_topic

condition:
  - condition: template
    value_template: "{{ trigger.payload_json.action != '' }}"

action:
  - variables:
      action: "{{ trigger.payload_json.action }}"
      input_text_var: !input last_pressed
      timer_var: !input dial_timer_helper
      active_time: !input dial_active_time
      
      # Zmienne świateł
      light_1: !input btn_1_light
      light_2: !input btn_2_light
      light_3: !input btn_3_light
      light_4: !input btn_4_light

  # === 1. KLIKNIĘCIA (Logika wyboru i Timera) ===
  - choose:
      - conditions: "{{ action is match('^button_[1-4]_press$') }}"
        sequence:
          # Zapisz ID przycisku
          - service: input_text.set_value
            target:
              entity_id: "{{ input_text_var }}"
            data:
              value: "{{ action | regex_replace(find='[^1-4]', replace='') }}"
          
          # Restart Timera
          - service: timer.start
            target:
              entity_id: "{{ timer_var }}"
            data:
              duration: "{{ active_time }}"
          
          # Wykonaj akcję użytkownika
          - choose:
              - conditions: "{{ '1' in action }}"
                sequence: !input btn_1_action
              - conditions: "{{ '2' in action }}"
                sequence: !input btn_2_action
              - conditions: "{{ '3' in action }}"
                sequence: !input btn_3_action
              - conditions: "{{ '4' in action }}"
                sequence: !input btn_4_action

  # === 2. OBRÓT (Logika ściemniania) ===
  - choose:
      - conditions: 
          - "{{ 'dial_rotate' in action }}"
          - "{{ states(timer_var) == 'active' }}"
        sequence:
          - variables:
              current_btn: "{{ states(input_text_var) }}"
              target_light: >
                {% if current_btn == '1' %} {{ light_1 }}
                {% elif current_btn == '2' %} {{ light_2 }}
                {% elif current_btn == '3' %} {{ light_3 }}
                {% elif current_btn == '4' %} {{ light_4 }}
                {% else %} [] {% endif %}
              
              direction_multiplier: >
                {{ 1 if 'right' in action else -1 }}
              
              step_size: >
                {% if 'fast' in action %} 30
                {% elif 'slow' in action %} 15
                {% else %} 5 {% endif %}
              
              final_pct: "{{ step_size * direction_multiplier }}"

          # Wyślij komendę tylko jeśli zdefiniowano światło
          - if:
              - condition: template
                value_template: "{{ target_light != [] and target_light != None and target_light != '[]' }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: "{{ target_light }}"
                data:
                  brightness_step_pct: "{{ final_pct }}"
                  transition: 0.1
