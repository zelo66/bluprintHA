blueprint:
  name: Philips Hue Tap Dial - Full Control (zigbee2mqtt)
  domain: automation
  description: >
    Pełna kontrola Philips Hue Tap Dial przez zigbee2mqtt.
    
    **Funkcje:**
    - Single press, Double press, Hold dla każdego przycisku
    - Obrót pokrętła w 3 prędkościach (step/slow/fast)
    - Pokrętło działa inaczej dla każdego przycisku
    
    **Wymagane helpery:**
    - Counter (do wykrywania double press)
    - Input Text (do zapamiętania ostatniego przycisku)
  input:
    mqtt_topic:
      name: MQTT Topic
      description: Topic urządzenia w zigbee2mqtt (np. zigbee2mqtt/Adrian_Przełącznik_Główny_HUE)
      default: zigbee2mqtt/<device name>
      selector:
        text:
    tap_counter:
      name: Counter Helper (wykrywanie multi-press)
      description: Utwórz Counter helper dla tego switcha
      selector:
        entity:
          domain:
            - counter
          multiple: false
    last_pressed:
      name: Input Text Helper (ostatni przycisk)
      description: Utwórz Input Text helper - każdy switch potrzebuje osobnego!
      selector:
        entity:
          domain:
            - input_text
          multiple: false
    
    # Button 1
    button_1_single_press:
      name: Button 1 - Single Press
      default: []
      selector:
        action: {}
    button_1_double_press:
      name: Button 1 - Double Press
      default: []
      selector:
        action: {}
    button_1_hold:
      name: Button 1 - Hold
      default: []
      selector:
        action: {}
    button_1_rotate_right_step:
      name: Button 1 - Rotate Right (Step)
      default: []
      selector:
        action: {}
    button_1_rotate_right_slow:
      name: Button 1 - Rotate Right (Slow)
      default: []
      selector:
        action: {}
    button_1_rotate_right_fast:
      name: Button 1 - Rotate Right (Fast)
      default: []
      selector:
        action: {}
    button_1_rotate_left_step:
      name: Button 1 - Rotate Left (Step)
      default: []
      selector:
        action: {}
    button_1_rotate_left_slow:
      name: Button 1 - Rotate Left (Slow)
      default: []
      selector:
        action: {}
    button_1_rotate_left_fast:
      name: Button 1 - Rotate Left (Fast)
      default: []
      selector:
        action: {}
    
    # Button 2
    button_2_single_press:
      name: Button 2 - Single Press
      default: []
      selector:
        action: {}
    button_2_double_press:
      name: Button 2 - Double Press
      default: []
      selector:
        action: {}
    button_2_hold:
      name: Button 2 - Hold
      default: []
      selector:
        action: {}
    button_2_rotate_right_step:
      name: Button 2 - Rotate Right (Step)
      default: []
      selector:
        action: {}
    button_2_rotate_right_slow:
      name: Button 2 - Rotate Right (Slow)
      default: []
      selector:
        action: {}
    button_2_rotate_right_fast:
      name: Button 2 - Rotate Right (Fast)
      default: []
      selector:
        action: {}
    button_2_rotate_left_step:
      name: Button 2 - Rotate Left (Step)
      default: []
      selector:
        action: {}
    button_2_rotate_left_slow:
      name: Button 2 - Rotate Left (Slow)
      default: []
      selector:
        action: {}
    button_2_rotate_left_fast:
      name: Button 2 - Rotate Left (Fast)
      default: []
      selector:
        action: {}
    
    # Button 3
    button_3_single_press:
      name: Button 3 - Single Press
      default: []
      selector:
        action: {}
    button_3_double_press:
      name: Button 3 - Double Press
      default: []
      selector:
        action: {}
    button_3_hold:
      name: Button 3 - Hold
      default: []
      selector:
        action: {}
    button_3_rotate_right_step:
      name: Button 3 - Rotate Right (Step)
      default: []
      selector:
        action: {}
    button_3_rotate_right_slow:
      name: Button 3 - Rotate Right (Slow)
      default: []
      selector:
        action: {}
    button_3_rotate_right_fast:
      name: Button 3 - Rotate Right (Fast)
      default: []
      selector:
        action: {}
    button_3_rotate_left_step:
      name: Button 3 - Rotate Left (Step)
      default: []
      selector:
        action: {}
    button_3_rotate_left_slow:
      name: Button 3 - Rotate Left (Slow)
      default: []
      selector:
        action: {}
    button_3_rotate_left_fast:
      name: Button 3 - Rotate Left (Fast)
      default: []
      selector:
        action: {}
    
    # Button 4
    button_4_single_press:
      name: Button 4 - Single Press
      default: []
      selector:
        action: {}
    button_4_double_press:
      name: Button 4 - Double Press
      default: []
      selector:
        action: {}
    button_4_hold:
      name: Button 4 - Hold
      default: []
      selector:
        action: {}
    button_4_rotate_right_step:
      name: Button 4 - Rotate Right (Step)
      default: []
      selector:
        action: {}
    button_4_rotate_right_slow:
      name: Button 4 - Rotate Right (Slow)
      default: []
      selector:
        action: {}
    button_4_rotate_right_fast:
      name: Button 4 - Rotate Right (Fast)
      default: []
      selector:
        action: {}
    button_4_rotate_left_step:
      name: Button 4 - Rotate Left (Step)
      default: []
      selector:
        action: {}
    button_4_rotate_left_slow:
      name: Button 4 - Rotate Left (Slow)
      default: []
      selector:
        action: {}
    button_4_rotate_left_fast:
      name: Button 4 - Rotate Left (Fast)
      default: []
      selector:
        action: {}

mode: restart
max_exceeded: silent

trigger:
  - platform: mqtt
    topic: !input mqtt_topic

condition:
  - condition: template
    value_template: "{{ trigger.payload_json.action is defined and trigger.payload_json.action != '' }}"

action:
  - variables:
      input_text_var: !input last_pressed
      counter_var: !input tap_counter
      action: "{{ trigger.payload_json.action }}"
  
  # Wykrywanie button_press - inkrementuj licznik
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ action is match('^button_[1-4]_press$') }}"
        sequence:
          # Jeśli to inny przycisk niż ostatnio - zresetuj licznik
          - if:
              - condition: template
                value_template: "{{ action | regex_replace(find='[^1-4]', replace='') != states(input_text_var) }}"
            then:
              - service: counter.reset
                target:
                  entity_id: "{{ counter_var }}"
          # Zapisz numer przycisku
          - service: input_text.set_value
            data:
              value: "{{ action | regex_replace(find='[^1-4]', replace='') }}"
            target:
              entity_id: "{{ input_text_var }}"
          # Zwiększ licznik
          - service: counter.increment
            target:
              entity_id: "{{ counter_var }}"
          # Czekaj 1s na kolejne kliknięcia
          - delay:
              seconds: 1
          # Zresetuj licznik
          - service: counter.reset
            target:
              entity_id: "{{ counter_var }}"
      
      # Wykryto double press
      - conditions:
          - condition: template
            value_template: "{{ action is match('button_[1-4]_press_release') and states(counter_var) | int > 1 }}"
        sequence:
          - choose:
              - conditions: "{{ action == 'button_1_press_release' }}"
                sequence: !input button_1_double_press
              - conditions: "{{ action == 'button_2_press_release' }}"
                sequence: !input button_2_double_press
              - conditions: "{{ action == 'button_3_press_release' }}"
                sequence: !input button_3_double_press
              - conditions: "{{ action == 'button_4_press_release' }}"
                sequence: !input button_4_double_press
    
    # Domyślne akcje (single press, hold, rotation)
    default:
      # Jeśli release - sprawdź czy nie double press
      - if:
          - condition: template
            value_template: "{{ action is match('button_[1-4]_press_release') }}"
        then:
          - delay:
              milliseconds: 250
          - if:
              - condition: template
                value_template: "{{ states(counter_var) | int > 1 }}"
            then:
              - stop: "Double press detected"
      
      # Akcje pokrętła i przycisków
      - choose:
          # === BUTTON 1 ROTATIONS ===
          - conditions: "{{ states(input_text_var) == '1' and action == 'dial_rotate_right_step' }}"
            sequence: !input button_1_rotate_right_step
          - conditions: "{{ states(input_text_var) == '1' and action == 'dial_rotate_right_slow' }}"
            sequence: !input button_1_rotate_right_slow
          - conditions: "{{ states(input_text_var) == '1' and action == 'dial_rotate_right_fast' }}"
            sequence: !input button_1_rotate_right_fast
          - conditions: "{{ states(input_text_var) == '1' and action == 'dial_rotate_left_step' }}"
            sequence: !input button_1_rotate_left_step
          - conditions: "{{ states(input_text_var) == '1' and action == 'dial_rotate_left_slow' }}"
            sequence: !input button_1_rotate_left_slow
          - conditions: "{{ states(input_text_var) == '1' and action == 'dial_rotate_left_fast' }}"
            sequence: !input button_1_rotate_left_fast
          
          # === BUTTON 2 ROTATIONS ===
          - conditions: "{{ states(input_text_var) == '2' and action == 'dial_rotate_right_step' }}"
            sequence: !input button_2_rotate_right_step
          - conditions: "{{ states(input_text_var) == '2' and action == 'dial_rotate_right_slow' }}"
            sequence: !input button_2_rotate_right_slow
          - conditions: "{{ states(input_text_var) == '2' and action == 'dial_rotate_right_fast' }}"
            sequence: !input button_2_rotate_right_fast
          - conditions: "{{ states(input_text_var) == '2' and action == 'dial_rotate_left_step' }}"
            sequence: !input button_2_rotate_left_step
          - conditions: "{{ states(input_text_var) == '2' and action == 'dial_rotate_left_slow' }}"
            sequence: !input button_2_rotate_left_slow
          - conditions: "{{ states(input_text_var) == '2' and action == 'dial_rotate_left_fast' }}"
            sequence: !input button_2_rotate_left_fast
          
          # === BUTTON 3 ROTATIONS ===
          - conditions: "{{ states(input_text_var) == '3' and action == 'dial_rotate_right_step' }}"
            sequence: !input button_3_rotate_right_step
          - conditions: "{{ states(input_text_var) == '3' and action == 'dial_rotate_right_slow' }}"
            sequence: !input button_3_rotate_right_slow
          - conditions: "{{ states(input_text_var) == '3' and action == 'dial_rotate_right_fast' }}"
            sequence: !input button_3_rotate_right_fast
          - conditions: "{{ states(input_text_var) == '3' and action == 'dial_rotate_left_step' }}"
            sequence: !input button_3_rotate_left_step
          - conditions: "{{ states(input_text_var) == '3' and action == 'dial_rotate_left_slow' }}"
            sequence: !input button_3_rotate_left_slow
          - conditions: "{{ states(input_text_var) == '3' and action == 'dial_rotate_left_fast' }}"
            sequence: !input button_3_rotate_left_fast
          
          # === BUTTON 4 ROTATIONS ===
          - conditions: "{{ states(input_text_var) == '4' and action == 'dial_rotate_right_step' }}"
            sequence: !input button_4_rotate_right_step
          - conditions: "{{ states(input_text_var) == '4' and action == 'dial_rotate_right_slow' }}"
            sequence: !input button_4_rotate_right_slow
          - conditions: "{{ states(input_text_var) == '4' and action == 'dial_rotate_right_fast' }}"
            sequence: !input button_4_rotate_right_fast
          - conditions: "{{ states(input_text_var) == '4' and action == 'dial_rotate_left_step' }}"
            sequence: !input button_4_rotate_left_step
          - conditions: "{{ states(input_text_var) == '4' and action == 'dial_rotate_left_slow' }}"
            sequence: !input button_4_rotate_left_slow
          - conditions: "{{ states(input_text_var) == '4' and action == 'dial_rotate_left_fast' }}"
            sequence: !input button_4_rotate_left_fast
          
          # === BUTTON PRESSES ===
          - conditions: "{{ action == 'button_1_press_release' }}"
            sequence: !input button_1_single_press
          - conditions: "{{ action == 'button_1_hold' }}"
            sequence: !input button_1_hold
          
          - conditions: "{{ action == 'button_2_press_release' }}"
            sequence: !input button_2_single_press
          - conditions: "{{ action == 'button_2_hold' }}"
            sequence: !input button_2_hold
          
          - conditions: "{{ action == 'button_3_press_release' }}"
            sequence: !input button_3_single_press
          - conditions: "{{ action == 'button_3_hold' }}"
            sequence: !input button_3_hold
          
          - conditions: "{{ action == 'button_4_press_release' }}"
            sequence: !input button_4_single_press
          - conditions: "{{ action == 'button_4_hold' }}"
            sequence: !input button_4_hold
