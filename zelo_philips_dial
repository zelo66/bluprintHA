blueprint:
  name: "Philips Hue Tap Dial - Smart Dimmer Mode (Z2M)"
  domain: automation
  description: >
    Zaawansowana obsługa Hue Tap Dial.
    
    **JAK TO DZIAŁA:**
    1. Klikasz przycisk (1, 2, 3 lub 4).
    2. Uruchamia się **Timer** (np. na 5 sekund).
    3. Jeśli w konfiguracji wybrałeś **Światło do sterowania** dla tego przycisku, pokrętło automatycznie zmienia jego jasność.
    4. Szybkie kręcenie zmienia jasność mocniej, wolne - precyzyjniej.
    5. Po upływie czasu (Timer wygasł), pokrętło przestaje sterować światłem (zabezpieczenie).
    
    **Wymagania:**
    - Utworzony Helper typu **Timer** (Minutnik).
    - Utworzony Helper typu **Counter** (Licznik).
    - Utworzony Helper typu **Input Text**.
  
  input:
    mqtt_topic:
      name: "Zigbee2MQTT Topic"
      selector:
        text:
    
    # Helpery
    dial_timer_helper:
      name: "Helper: Timer (Minutnik)"
      description: "Wymagany do odliczania czasu aktywności pokrętła (np. 5s)."
      selector:
        entity:
          domain: timer
    tap_counter:
      name: "Helper: Counter (Licznik)"
      selector:
        entity:
          domain: counter
    last_pressed:
      name: "Helper: Input Text"
      selector:
        entity:
          domain: input_text

    # Konfiguracja czasów
    dial_active_time:
      name: "Czas aktywności pokrętła (s)"
      default: 5
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: s
          mode: slider
    double_click_delay:
      name: "Czas na double click (s)"
      default: 1
      selector:
        number:
          min: 0.3
          max: 3.0
          step: 0.1
          unit_of_measurement: s
          mode: slider

    # === BUTTON 1 CONFIG ===
    btn_1_light:
      name: "(B1) Sterowanie jasnością (Opcjonalne)"
      description: "Wybierz światło, które ma być ściemniane po wciśnięciu przycisku 1."
      default: []
      selector:
        entity:
          domain: light
          multiple: true
    btn_1_action:
      name: "(B1) Akcja po kliknięciu"
      default: []
      selector:
        action: {}

    # === BUTTON 2 CONFIG ===
    btn_2_light:
      name: "(B2) Sterowanie jasnością (Opcjonalne)"
      description: "Wybierz światło dla przycisku 2."
      default: []
      selector:
        entity:
          domain: light
          multiple: true
    btn_2_action:
      name: "(B2) Akcja po kliknięciu"
      default: []
      selector:
        action: {}

    # === BUTTON 3 CONFIG ===
    btn_3_light:
      name: "(B3) Sterowanie jasnością (Opcjonalne)"
      description: "Wybierz światło dla przycisku 3."
      default: []
      selector:
        entity:
          domain: light
          multiple: true
    btn_3_action:
      name: "(B3) Akcja po kliknięciu"
      default: []
      selector:
        action: {}

    # === BUTTON 4 CONFIG ===
    btn_4_light:
      name: "(B4) Sterowanie jasnością (Opcjonalne)"
      description: "Wybierz światło dla przycisku 4."
      default: []
      selector:
        entity:
          domain: light
          multiple: true
    btn_4_action:
      name: "(B4) Akcja po kliknięciu"
      default: []
      selector:
        action: {}

mode: queued
max: 10

trigger:
  - platform: mqtt
    topic: !input mqtt_topic

condition:
  - condition: template
    value_template: "{{ trigger.payload_json.action != '' }}"

action:
  - variables:
      action: "{{ trigger.payload_json.action }}"
      input_text_var: !input last_pressed
      timer_var: !input dial_timer_helper
      active_time: !input dial_active_time
      
      # Mapowanie świateł do zmiennych
      light_1: !input btn_1_light
      light_2: !input btn_2_light
      light_3: !input btn_3_light
      light_4: !input btn_4_light

  # === 1. OBSŁUGA KLIKNIĘĆ (AKTYWACJA TRYBU) ===
  - choose:
      - conditions: "{{ action is match('^button_[1-4]_press$') }}"
        sequence:
          # Zapisz, który przycisk jest aktywny
          - service: input_text.set_value
            target:
              entity_id: "{{ input_text_var }}"
            data:
              value: "{{ action | regex_replace(find='[^1-4]', replace='') }}"
          
          # Uruchom Timer (okno czasowe na kręcenie)
          - service: timer.start
            target:
              entity_id: "{{ timer_var }}"
            data:
              duration: "{{ active_time }}"
          
          # Wykonaj przypisaną akcję (np. Toggle światła)
          - choose:
              - conditions: "{{ '1' in action }}"
                sequence: !input btn_1_action
              - conditions: "{{ '2' in action }}"
                sequence: !input btn_2_action
              - conditions: "{{ '3' in action }}"
                sequence: !input btn_3_action
              - conditions: "{{ '4' in action }}"
                sequence: !input btn_4_action

  # === 2. OBSŁUGA OBROTU (DIAL) ===
  - choose:
      - conditions: 
          - "{{ 'dial_rotate' in action }}"     # To jest obrót
          - "{{ states(timer_var) == 'active' }}" # Timer jest aktywny
        sequence:
          - variables:
              current_btn: "{{ states(input_text_var) }}"
              # Określ cel (światło) na podstawie zapisanego przycisku
              target_light: >
                {% if current_btn == '1' %} {{ light_1 }}
                {% elif current_btn == '2' %} {{ light_2 }}
                {% elif current_btn == '3' %} {{ light_3 }}
                {% elif current_btn == '4' %} {{ light_4 }}
                {% else %} [] {% endif %}
              
              # Określ kierunek (+/-)
              direction_multiplier: >
                {{ 1 if 'right' in action else -1 }}
              
              # Określ siłę kroku na podstawie prędkości (step/slow/fast)
              step_size: >
                {% if 'fast' in action %} 30
                {% elif 'slow' in action %} 15
                {% else %} 5 {% endif %}
              
              final_pct: "{{ step_size * direction_multiplier }}"

          # Wykonaj ściemnianie TYLKO jeśli wybrano światło dla tego przycisku
          - if:
              - condition: template
                value_template: "{{ target_light != [] and target_light != None and target_light != '[]' }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: "{{ target_light }}"
                data:
                  brightness_step_pct: "{{ final_pct }}"
                  transition: 0.1
